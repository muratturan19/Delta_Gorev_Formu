{% extends "base.html" %}
{% block title %}Raporlama{% endblock %}

{% block content %}
<div class="report-page">
    <div class="report-header">
        <div>
            <h2>ğŸ“ˆ Raporlama Panosu</h2>
            <p>SeÃ§tiÄŸiniz tarih aralÄ±ÄŸÄ± iÃ§in gÃ¶rev ve personel bazlÄ± Ã¶zetleri inceleyin.</p>
        </div>
        <form method="get" class="report-filter-form">
            <div class="filter-inputs">
                <label>
                    <span>BaÅŸlangÄ±Ã§</span>
                    <input type="date" name="start_date" value="{{ selected_start }}">
                </label>
                <label>
                    <span>BitiÅŸ</span>
                    <input type="date" name="end_date" value="{{ selected_end }}">
                </label>
                <button type="submit" class="button primary">Filtrele</button>
            </div>
            <div class="quick-filters">
                {% for key, item in quick_filters.items() %}
                <a class="button ghost" href="{{ url_for('reports', start_date=item.start, end_date=item.end) }}">{{ item.label }}</a>
                {% endfor %}
            </div>
        </form>
    </div>

    <div class="report-summary-cards">
        <div class="report-card">
            <span class="report-card-label">Toplam Form</span>
            <strong class="report-card-value">{{ report.total_forms }}</strong>
            <small>
                {{ report.form_origins.direct }} doÄŸrudan, {{ report.form_origins.converted }} talep dÃ¶nÃ¼ÅŸÃ¼mÃ¼<br>
                {{ report.filters.start_date or '-' }} â†’ {{ report.filters.end_date or '-' }}
            </small>
        </div>
        <div class="report-card">
            <span class="report-card-label">GÃ¶rev Talepleri</span>
            <strong class="report-card-value">{{ report.task_requests.total }}</strong>
            <small>
                {{ report.task_requests.converted }} gÃ¶rev formuna dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼
                ({{ "%.0f"|format(report.task_requests.conversion_rate) }}%)
            </small>
        </div>
        <div class="report-card">
            <span class="report-card-label">GÃ¶revlendirilen KiÅŸi SayÄ±sÄ±</span>
            <strong class="report-card-value">{{ report.unique_person_count }}</strong>
            <small>KiÅŸi bazÄ±nda toplam gÃ¶revlendirme: {{ report.person_breakdown|sum(attribute='count') }}</small>
        </div>
        <div class="report-card">
            <span class="report-card-label">Toplam Yol SÃ¼resi</span>
            <strong class="report-card-value">{{ "%.2f"|format(report.travel_hours.total) }} sa</strong>
            <small>{{ report.travel_hours.samples }} gÃ¶revden ortalama {{ "%.2f"|format(report.travel_hours.average) }} sa</small>
        </div>
        <div class="report-card">
            <span class="report-card-label">Toplam Ã‡alÄ±ÅŸma SÃ¼resi</span>
            <strong class="report-card-value">{{ "%.2f"|format(report.work_hours.total) }} sa</strong>
            <small>{{ report.work_hours.samples }} gÃ¶revden ortalama {{ "%.2f"|format(report.work_hours.average) }} sa</small>
        </div>
    </div>

    <div class="report-grid">
        <section class="report-section">
            <header>
                <h3>ğŸ‘¥ KiÅŸi BazÄ±nda GÃ¶revlendirme Adedi</h3>
            </header>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>KiÅŸi</th>
                        <th>GÃ¶rev SayÄ±sÄ±</th>
                    </tr>
                </thead>
                <tbody>
                    {% if report.person_breakdown %}
                        {% for item in report.person_breakdown %}
                        <tr>
                            <td>{{ item.person }}</td>
                            <td>{{ item.count }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="2" class="empty-cell">KayÄ±t bulunamadÄ±.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </section>

        <section class="report-section">
            <header>
                <h3>ğŸ“ Lokasyon / Firma BazÄ±nda GÃ¶revlendirmeler</h3>
            </header>
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Lokasyon</th>
                        <th>GÃ¶rev SayÄ±sÄ±</th>
                    </tr>
                </thead>
                <tbody>
                    {% if report.locations %}
                        {% for item in report.locations %}
                        <tr>
                            <td>{{ item.label }}</td>
                            <td>{{ item.count }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="2" class="empty-cell">KayÄ±t bulunamadÄ±.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </section>
    </div>

    <div class="report-grid single">
        <section class="report-section">
            <header>
                <h3>ğŸ’¸ GÃ¶rev BazÄ±nda Harcama GrafiÄŸi</h3>
                <p>Her form iÃ§in girilen harcama bildirimi sayÄ±sÄ±nÄ± gÃ¶sterir.</p>
            </header>
            <canvas id="expenseChart" height="220"></canvas>
        </section>
    </div>

    <section class="report-section">
        <header>
            <h3>ğŸ•’ GÃ¶rev SÃ¼releri</h3>
            <p>Her gÃ¶rev iÃ§in yol ve Ã§alÄ±ÅŸma sÃ¼relerinin karÅŸÄ±laÅŸtÄ±rmasÄ±.</p>
        </header>
        <div class="report-table-wrapper">
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Form No</th>
                        <th>GÃ¶rev TanÄ±mÄ±</th>
                        <th>GÃ¶rev Tarihi</th>
                        <th>GÃ¶revli Personel</th>
                        <th>Yol SÃ¼resi (sa)</th>
                        <th>Ã‡alÄ±ÅŸma SÃ¼resi (sa)</th>
                        <th>Harcama Bildirimi</th>
                        <th>Lokasyon</th>
                    </tr>
                </thead>
                <tbody>
                    {% if report.forms %}
                        {% for form in report.forms %}
                        <tr>
                            <td>{{ form.form_no }}</td>
                            <td>{{ form.gorev_tanimi or '-' }}</td>
                            <td>{{ form.gorev_tarih or '-' }}</td>
                            <td>
                                {% if form.personel %}
                                    <ul class="inline-list">
                                        {% for person in form.personel %}
                                        <li>{{ person }}</li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ form.travel_hours if form.travel_hours is not none else '-' }}</td>
                            <td>{{ form.work_hours if form.work_hours is not none else '-' }}</td>
                            <td>{{ form.expense_count }}</td>
                            <td>
                                {% if form.gorev_il or form.gorev_ilce or form.gorev_firma %}
                                    {{ [form.gorev_il, form.gorev_ilce, form.gorev_firma] | select | list | join(', ') }}
                                {% else %}
                                    {{ form.gorev_yeri or '-' }}
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="empty-cell">SeÃ§ilen tarih aralÄ±ÄŸÄ± iÃ§in gÃ¶rev bulunamadÄ±.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" integrity="sha384-nCfpnRfpBefD31z9rbvJNdaI6pI++DhfSb9VInA36TObgATJE0nN8tBCZ6irda5x" crossorigin="anonymous"></script>
<script>
    const expenseCtx = document.getElementById('expenseChart');
    if (expenseCtx) {
        const expenseLabels = {{ report.expense_chart['labels'] | tojson }};
        const expenseValues = {{ report.expense_chart['values'] | tojson }};
        new Chart(expenseCtx, {
            type: 'bar',
            data: {
                labels: expenseLabels,
                datasets: [{
                    label: 'Harcama bildirimi adedi',
                    data: expenseValues,
                    backgroundColor: 'rgba(13, 71, 161, 0.6)',
                    borderRadius: 6,
                    borderSkipped: false,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            autoSkip: false,
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
