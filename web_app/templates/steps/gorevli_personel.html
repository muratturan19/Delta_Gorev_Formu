{% extends "base.html" %}
{% block title %}Form {{ form_no }} · Görevli Personel{% endblock %}

{% block steps %}
<div class="step-indicator">
    {% for step in FORM_STEPS %}
        <div class="step {{ 'active' if loop.index0 == step_index else '' }} {{ 'complete' if loop.index0 < step_index else '' }}">
            <span class="step-number">{{ loop.index }}</span>
            <span class="step-title">{{ step.title }}</span>
        </div>
    {% endfor %}
</div>
{% endblock %}

{% block content %}
<h2>👥 Görevli Personel</h2>
<form method="post" action="{{ url_for('form_wizard', form_no=form_no, step=step_index) }}" class="form-card">
    <input type="hidden" name="action" value="next">
    <fieldset class="form-fields" {% if read_only_step %}disabled{% endif %}>
        <div class="form-row">
            <label for="gorev_tarih">Görev Tarihi</label>
            <input id="gorev_tarih" name="gorev_tarih" type="date" value="{{ form_data.get('gorev_tarih', '') | to_html_date }}">
        </div>
        {% for index in range(1, 6) %}
        <div class="form-row">
            <label for="personel_{{ index }}">Personel {{ index }}</label>
            <select id="personel_{{ index }}" name="personel_{{ index }}" class="personel-select">
                <option value="">Seçiniz</option>
                {% for user in personel_users %}
                    <option value="{{ user.full_name }}" {% if form_data.get('personel_' ~ index) == user.full_name %}selected{% endif %}>{{ user.full_name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endfor %}
    </fieldset>
    {% if is_employee and read_only_step %}
    <div class="form-actions single">
        <a class="button primary" href="{{ url_for('form_wizard', form_no=form_no, step=5) }}">Görev Bilgilerini Doldur →</a>
    </div>
    {% else %}
    <div class="form-actions">
        <button type="submit" class="button secondary" data-action="submit-step" data-value="previous">← Geri</button>
        <button type="submit" class="button save" data-action="submit-step" data-value="save">💾 Kaydet</button>
        <button type="submit" class="button primary" data-action="submit-step" data-value="next">İleri →</button>
    </div>
    {% endif %}
</form>
{% endblock %}

{% block scripts %}
<script>
    const selects = document.querySelectorAll('.personel-select');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            const values = Array.from(selects).map(el => el.value).filter(Boolean);
            const duplicates = values.filter((value, index, arr) => arr.indexOf(value) !== index);
            selects.forEach(el => el.classList.remove('duplicate'));
            if (duplicates.length) {
                selects.forEach(el => {
                    if (duplicates.includes(el.value)) {
                        el.classList.add('duplicate');
                    }
                });
            }
        });
    });
    selects.forEach(select => select.dispatchEvent(new Event('change')));
</script>
{% endblock %}
