{% extends "base.html" %}
{% block title %}Form {{ form_no }} · Görev Bilgileri{% endblock %}

{% block steps %}
<div class="step-indicator">
    {% for step in FORM_STEPS %}
        <div class="step {{ 'active' if loop.index0 == step_index else '' }} {{ 'complete' if loop.index0 < step_index else '' }}">
            <span class="step-number">{{ loop.index }}</span>
            <span class="step-title">{{ step.title }}</span>
        </div>
    {% endfor %}
</div>
{% endblock %}

{% block content %}
<h2>🕐 Görev Bilgileri</h2>
<form method="post" enctype="multipart/form-data" action="{{ url_for('form_wizard', form_no=form_no, step=step_index) }}" class="form-card form-scroll">
    <input type="hidden" name="action" value="next">
    <div class="grid grid-2">
        <div class="form-row">
            <label for="yola_cikis_tarih">Yola Çıkış Tarihi</label>
            <input id="yola_cikis_tarih" name="yola_cikis_tarih" type="date" value="{{ form_data.get('yola_cikis_tarih', '') | to_html_date }}">
        </div>
        <div class="form-row">
            <label for="yola_cikis_saat">Yola Çıkış Saati</label>
            <input id="yola_cikis_saat" name="yola_cikis_saat" type="time" value="{{ form_data.get('yola_cikis_saat', '') }}">
        </div>
        <div class="form-row">
            <label for="donus_tarih">Dönüş Tarihi</label>
            <input id="donus_tarih" name="donus_tarih" type="date" value="{{ form_data.get('donus_tarih', '') | to_html_date }}">
        </div>
        <div class="form-row">
            <label for="donus_saat">Dönüş Saati</label>
            <input id="donus_saat" name="donus_saat" type="time" value="{{ form_data.get('donus_saat', '') }}">
        </div>
        <div class="form-row">
            <label for="calisma_baslangic_tarih">Çalışma Başlangıç Tarihi</label>
            <input id="calisma_baslangic_tarih" name="calisma_baslangic_tarih" type="date" value="{{ form_data.get('calisma_baslangic_tarih', '') | to_html_date }}">
        </div>
        <div class="form-row">
            <label for="calisma_baslangic_saat">Çalışma Başlangıç Saati</label>
            <input id="calisma_baslangic_saat" name="calisma_baslangic_saat" type="time" value="{{ form_data.get('calisma_baslangic_saat', '') }}">
        </div>
        <div class="form-row">
            <label for="calisma_bitis_tarih">Çalışma Bitiş Tarihi</label>
            <input id="calisma_bitis_tarih" name="calisma_bitis_tarih" type="date" value="{{ form_data.get('calisma_bitis_tarih', '') | to_html_date }}">
        </div>
        <div class="form-row">
            <label for="calisma_bitis_saat">Çalışma Bitiş Saati</label>
            <input id="calisma_bitis_saat" name="calisma_bitis_saat" type="time" value="{{ form_data.get('calisma_bitis_saat', '') }}">
        </div>
        <div class="form-row">
            <label for="mola_suresi">Toplam Mola (dakika)</label>
            <input id="mola_suresi" name="mola_suresi" type="number" min="0" step="5" value="{{ form_data.get('mola_suresi', '') }}">
        </div>
    </div>
    <div class="form-row">
        <label for="yapilan_isler">Yapılan İşler</label>
        <textarea id="yapilan_isler" name="yapilan_isler" rows="6" placeholder="Görev kapsamında yapılan işleri yazınız">{{ form_data.get('yapilan_isler', '') }}</textarea>
    </div>
    <div class="form-section">
        <h3>💸 Harcama Bildirimi</h3>
        <div class="grid grid-2">
            <div class="form-row">
                <label for="harcama_aciklamasi">Harcama Açıklaması</label>
                <input id="harcama_aciklamasi" name="harcama_aciklamasi" type="text" placeholder="Örn. Konaklama, yakıt, yemek...">
            </div>
            <div class="form-row">
                <label for="harcama_dosyalari">Fiş / Görsel</label>
                <input id="harcama_dosyalari" name="harcama_dosyalari" type="file" accept="image/*" multiple>
                <small>Bir veya daha fazla görsel dosya seçebilirsiniz.</small>
            </div>
        </div>
        <div class="form-row">
            <button type="submit" class="button ghost" data-action="submit-step" data-value="add_expense">➕ Ekle</button>
        </div>
        {% if form_data.get('harcama_bildirimleri') %}
        <ul class="attachment-list expense-list">
            {% for expense in form_data.get('harcama_bildirimleri', []) %}
            <li>
                <div class="attachment-meta">
                    <span class="attachment-name">Harcama {{ loop.index }}</span>
                    <span>{{ expense.description or 'Açıklama belirtilmedi' }}</span>
                    {% if expense.attachments %}
                    <ul class="receipt-list">
                        {% for receipt in expense.attachments %}
                        <li>
                            <a href="{{ url_for('download_attachment', form_no=form_no, filename=receipt.filename) }}" target="_blank">{{ receipt.original_name }}</a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <small>Görsel eklenmedi.</small>
                    {% endif %}
                </div>
                <div class="attachment-actions">
                    <button type="submit" class="button danger small" name="remove_expense" value="{{ loop.index0 }}" data-action="submit-step" data-value="remove_expense">Sil</button>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <div class="form-row">
        <label for="gorev_ekleri">Görev Ekleri</label>
        <input id="gorev_ekleri" name="gorev_ekleri" type="file" multiple>
        <small>Birden fazla dosya seçebilirsiniz. Fotoğraflar, raporlar veya diğer belgeleri ekleyin.</small>
        {% if form_data.get('gorev_ekleri') %}
        <ul class="attachment-list">
            {% for attachment in form_data.get('gorev_ekleri', []) %}
            <li>
                <div class="attachment-meta">
                    <span class="attachment-name">{{ attachment.original_name }}</span>
                </div>
                <div class="attachment-actions">
                    <a class="button ghost small" href="{{ url_for('download_attachment', form_no=form_no, filename=attachment.filename) }}" target="_blank">İndir</a>
                    <button type="submit" class="button danger small" name="remove_attachment" value="{{ attachment.filename }}">Sil</button>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    <div class="form-actions">
        <button type="submit" class="button secondary" data-action="submit-step" data-value="previous">← Geri</button>
        <button type="submit" class="button save" data-action="submit-step" data-value="save">💾 Kaydet</button>
        <button type="submit" class="button primary" data-action="submit-step" data-value="next">İleri →</button>
    </div>
</form>
{% endblock %}
