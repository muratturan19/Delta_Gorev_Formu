# Delta Portal Integration Guide for "gorev-formu"

This document outlines the technical requirements to integrate the `gorev-formu` (Flask) application into the Delta Portal infrastructure.

## 1. Architecture Overview

The Delta Portal runs on a **Dockerized** environment on an Ubuntu server.
- **Reverse Proxy**: A main Nginx container receives all traffic on port 80.
- **Routing**: Traffic is routed to different applications based on **URL subpaths**.
  - `http://portal.com/` -> Admin/Main App
  - `http://portal.com/hidrolik/` -> Hidrolik App
  - `http://portal.com/gorev/` -> **Gorve Formu App** (Target deployment)

## 2. Critical Requirements

To make the existing Flask application compatible with this architecture, specific changes are needed to handle **subpath routing**, **persistence**, and **containerization**.

### A. Subpath Routing (The most common point of failure)
The application will **not** be hosted at the root (`/`). It will be hosted at `/gorev/`.
This means:
1. All internal links generated by `url_for()` must include the `/gorev` prefix.
2. Static assets (CSS/JS) must be served from `/gorev/static/...`.
3. Redirects must go to `/gorev/target_page`.

**Action Items for Coder:**
*   **Configure Application Root**:
    *   Modify `webapp.py` to handle `SCRIPT_NAME` or a custom `URL_PREFIX` environment variable.
    *   Ideally, use `werkzeug.middleware.proxy_fix.ProxyFix` to trust headers like `X-Forwarded-Prefix` passed by Nginx.
    *   *Alternative*: Wrap the entire Flask app in a **Blueprint** with `url_prefix='/gorev'`.
    *   **Goal**: `url_for('index')` should output `/gorev/` (or `/gorev/index`), not `/`.

### B. Data Persistence (SQLite & Uploads)
Docker containers are ephemeral. Any data saved inside the container will be **lost** when the container updates.

**Action Items for Coder:**
*   **Centralize Data Paths**:
    *   Currently, the database (`forms.db`) seems to be in the root `/app` folder.
    *   Please modify the code to look for the database in a dedicated folder, e.g., `/app/data/forms.db`.
    *   Ensure uploads go to `/app/data/uploads` or `/app/uploads`.
*   **Environment Configuration**:
    *   Allow the database path and upload folder to be configured via **Environment Variables** (e.g., `DB_PATH`, `UPLOAD_FOLDER`).

### C. Docker Deployment
The application needs a production-ready `Dockerfile`.

**Action Items for Coder:**
*   **Use Gunicorn**: Do not use `python webapp.py` (Flask dev server) in production. Update `Dockerfile` to use `gunicorn` (e.g., `CMD ["gunicorn", "--bind", "0.0.0.0:5002", "webapp:app"]`).
*   **Dependencies**: Ensure `requirements.txt` is complete.
*   **Port**: Configure the container to expose port `5002`.

## 3. Recommended Implementation Steps

### Step 1: Update `webapp.py` for Prefix Handling
Example using ProxyFix (Standard approach for Nginx behind proxies):
```python
from flask import Flask
from werkzeug.middleware.proxy_fix import ProxyFix

app = Flask(__name__)

# Trust X-Forwarded-Proto, X-Forwarded-For, X-Forwarded-Prefix
app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_proto=1, x_host=1, x_prefix=1)
```
*Note: This relies on the Nginx proxy sending `X-Forwarded-Prefix`. If that's difficult to configure, using a Blueprint with an Env Var for the prefix is a robust fallback.*

### Step 2: Update Database Logic
In `core/form_service.py` (or wherever `get_db_path` is defined):
```python
def get_db_path(base_path: str = None) -> str:
    # Use ENV var if available, else default to 'data' folder
    data_dir = os.environ.get('DATA_FOLDER', 'data')
    os.makedirs(data_dir, exist_ok=True)
    return os.path.join(data_dir, "forms.db")
```

### Step 3: Dockerfile Update
```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
# Create volume mount point
RUN mkdir -p /app/data
ENV DATA_FOLDER=/app/data
EXPOSE 5002
CMD ["gunicorn", "--bind", "0.0.0.0:5002", "--workers", "3", "webapp:app"]
```

## 4. Integration Definition (For DevOps/Deployment)
Once the code is updated, it will be run with:

**Environment Variables:**
- `FLASK_APP=webapp.py`
- `FLASK_ENV=production`
- `SECRET_KEY=...`
- `DATA_FOLDER=/app/data`

**Volumes:**
- Host path `/opt/deltaproje/data/gorev-formu` mounted to `/app/data` (ensures database and uploads survive restarts).

---
**Summary for the Coder:**
> "Please start the web app so that it can run correctly under the **`/gorev`** URL path (not just root `/`). Ensure the SQLite database is saved in a distinct folder (like `/app/data`) so we can mount a volume there. Refactor the Dockerfile to use `gunicorn`."
